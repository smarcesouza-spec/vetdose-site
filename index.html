<script>
const form = document.getElementById("form");
const msgBox = document.getElementById("msg");

form.addEventListener("submit", async e => {
  e.preventDefault();
  msgBox.style.display = "block";
  msgBox.className = "box";
  msgBox.innerHTML = "Calculando...";

  const data = new FormData(form);

  const payload = {
    auth: {
      email: data.get("email"),
      apiKey: data.get("apiKey")
    },
    patient: {
      species: data.get("species"),
      breed: data.get("breed")
    },
    weight: {
      value: Number(data.get("weight")),
      unit: data.get("unit")
    },
    medication_id: data.get("medication_id"),
    context: {
      condition: data.get("condition")
    }
  };

  try {
    const res = await fetch("https://weakdamselfish-n8n.cloudify.live/webhook/vet-dose", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const json = await res.json();
    console.log("Resposta do n8n:", json);

    // Se veio success = false OU authorized = false ‚Üí tratar como erro
    if (json.success === false || json.authorized === false) {
      msgBox.classList.add("error");
      msgBox.innerHTML = "‚ùå " + (json.error || "Erro ao processar a solicita√ß√£o. Verifique suas credenciais ou fale com o suporte.");
      return;
    }

    // Se n√£o veio dose, mostra o JSON bruto pra debug
    if (json.dose_mg === undefined || json.dose_ml === undefined) {
      msgBox.classList.add("error");
      msgBox.innerHTML = "‚ö†Ô∏è Resposta inesperada do servidor:<br><pre style='white-space:pre-wrap;word-break:break-word;'>" +
        JSON.stringify(json, null, 2) + "</pre>";
      return;
    }

    // Sucesso
    msgBox.classList.add("success");
    msgBox.innerHTML = `
      <strong>Dose calculada com sucesso</strong><br><br>
      ‚öñÔ∏è Peso: ${json.weight_kg} kg<br>
      üíä Medicamento: ${json.medication_id}<br>
      üìè Dose: <strong>${json.dose_mg} mg (${json.dose_ml} mL)</strong><br>
      ${json.interval ? `‚è±Ô∏è Intervalo: ${json.interval}<br>` : ""}
      <br>
      ‚úÖ ${json.message || "C√°lculo realizado."}
    `;
  } catch (err) {
    console.error(err);
    msgBox.classList.add("error");
    msgBox.innerHTML = "Erro ao conectar com o servidor.";
  }
});
</script>
